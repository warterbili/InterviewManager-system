<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业邮件状态跟踪</title>
    <link rel="stylesheet" href="./common.css">
</head>
<body>
    <div class="page-header">
        <div class="container">
            <h1>企业邮件状态跟踪</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="/" class="back-btn">
                ← 返回主页
            </a>
        </div>
        
        <div id="mainContent">
            <div class="card">
                <div class="card-header">
                    <h2>邮件管理</h2>
                </div>
                
                <!-- 分类标签已移除，因为我们现在使用搜索功能 -->
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="searchKeyword">搜索:</label>
                        <div class="search-container">
                            <input type="text" id="searchKeyword" class="form-control" placeholder="输入关键词搜索邮件主题、正文或投递状态">
                            <button id="searchBtn" class="btn btn-primary btn-sm">搜索</button>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="startDate">开始日期:</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    
                    <div class="filter-group">
                        <label for="endDate">结束日期:</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    
                    <div class="filter-group">
                        <label for="sortOrder">排序方式:</label>
                        <select id="sortOrder" class="form-control">
                            <option value="desc">时间降序（最新优先）</option>
                            <option value="asc">时间升序（最早优先）</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>操作:</label>
                        <button id="fetchEmailsBtn" class="btn btn-primary btn-sm">获取邮件</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>邮件列表</h2>
                    <div class="email-list-actions">
                        <button class="btn btn-success" onclick="selectAll()">全选</button>
                        <button class="btn btn-danger" onclick="bulkDeleteEmails()">批量删除</button>
                    </div>
                </div>
                
                <div id="message" class="message"></div>
                
                <div class="table-container">
                    <table id="emailTable" class="email-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()"></th>
                                <th>邮件主题</th>
                                <th>发件人</th>
                                <th>发送时间</th>
                                <th>投递状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 检查配置，如果没有则重定向到配置页面
        // 从服务器获取配置
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                // 检查是否至少有一些基本配置
                const hasBasicDbConfig = config.db.host || config.db.user || config.db.password;
                const hasBasicEmailConfig = config.email.address || config.email.password || config.email.imap_server;
                
                // 如果没有任何基本配置，重定向到配置页面，并传递当前页面作为返回URL
                if (!hasBasicDbConfig && !hasBasicEmailConfig) {
                    const currentUrl = encodeURIComponent(window.location.pathname);
                    window.location.href = `/config?returnUrl=${currentUrl}`;
                }
            })
            .catch(error => {
                console.error('获取配置失败:', error);
                // 如果获取配置失败，也重定向到配置页面，并传递当前页面作为返回URL
                const currentUrl = encodeURIComponent(window.location.pathname);
                window.location.href = `/config?returnUrl=${currentUrl}`;
            });

        // API基础URL
        const API_BASE = '/api';
        
        // 存储当前邮件数据
        let currentEmails = [];
        
        // 存储当前显示的消息信息
        let currentMessage = {
            text: '',
            type: '',
            isPersistent: false
        };
        
        // 显示消息函数
        function showMessage(text, type, isPersistent = false) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type + ' show';
            
            // 更新当前消息信息
            currentMessage.text = text;
            currentMessage.type = type;
            currentMessage.isPersistent = isPersistent;
            
            // 非持久化消息4秒后自动清除，持久化消息不自动清除
            if (!isPersistent) {
                setTimeout(() => {
                    // 只有当当前显示的消息与存储的消息一致时才清除
                    if (messageEl.textContent === text) {
                        messageEl.textContent = '';
                        messageEl.className = '';
                        currentMessage.text = '';
                        currentMessage.type = '';
                        currentMessage.isPersistent = false;
                    }
                }, 4000);
            }
        }
        
        // 恢复显示持久化消息的函数
        function restorePersistentMessage() {
            if (currentMessage.isPersistent && currentMessage.text) {
                const messageEl = document.getElementById('message');
                messageEl.textContent = currentMessage.text;
                messageEl.className = 'message ' + currentMessage.type + ' show';
            }
        }

        // 页面加载时初始化邮件系统
        window.addEventListener('DOMContentLoaded', function() {
            initEmailSystem();
        });
        
        // 初始化邮件系统
        function initEmailSystem() {
            // 设置默认日期范围（最近7天）
            const today = new Date();
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // 格式化日期为 YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatDate(oneWeekAgo);
            document.getElementById('endDate').value = formatDate(today);
            
            // 为排序选择器添加事件监听器
            document.getElementById('sortOrder').addEventListener('change', sortEmails);
            
            // 为获取邮件按钮添加事件监听器
            document.getElementById('fetchEmailsBtn').addEventListener('click', fetchEmails);
            
            // 为搜索按钮添加事件监听器
            document.getElementById('searchBtn').addEventListener('click', function() {
                loadData();
            });
            
            // 为搜索框添加回车键事件监听器
            document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadData();
                }
            });
            
            // 初始加载数据（从数据库获取）
            loadData();
        }
        
        // 获取邮件
        function fetchEmails() {
            const btn = document.getElementById('fetchEmailsBtn');
            const originalText = btn.textContent;
            btn.textContent = '获取中...';
            btn.disabled = true;
            
            // 获取日期范围
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // 显示正在获取邮件的消息，并设置为持久化消息
            showMessage('正在获取邮件，这可能需要几分钟时间...', 'loading', true);
            
            // 验证日期
            if (!startDate || !endDate) {
                showMessage('请选择开始日期和结束日期', 'error');
                btn.textContent = originalText;
                btn.disabled = false;
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showMessage('开始日期不能晚于结束日期', 'error');
                btn.textContent = originalText;
                btn.disabled = false;
                return;
            }
            
            // 检查日期范围是否超过30天
            const dateDiff = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24);
            if (dateDiff > 30) {
                if (!confirm('日期范围超过30天，可能需要较长时间处理。是否继续？')) {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }
            }
            
            // 记录开始时间
            const startTime = Date.now();
            
            // 发送请求（带超时控制）
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5分钟超时
            
            fetch(`${API_BASE}/fetch-emails`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ startDate, endDate }),
                signal: controller.signal
            })
            .then(response => {
                // 调试：查看响应状态
                console.log('响应状态:', response.status);
                console.log('响应是否成功:', response.ok);
                
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => { throw err; });
                }
            })
            .then(result => {
                
                // 检查是否有结果返回
                if (!result) return;
                
                console.log('[DEBUG] 收到后端返回的数据:', result);
                
                if (result.success) {
                    const endTime = Date.now();
                    const duration = Math.round((endTime - startTime) / 1000);

                    // 构建更详细的消息
                    let detailedMessage = result.message || `邮件获取完成！耗时${duration}秒`;
                    console.log('[DEBUG] 处理前的消息:', detailedMessage);
                    console.log('[DEBUG] processedCount值:', result.processedCount);
                    
                    // 确保processedCount是有效数字
                    const processedCount = (result.processedCount !== undefined && !isNaN(result.processedCount)) ? 
                                          parseInt(result.processedCount) : 0;
                    console.log('[DEBUG] 转换后的processedCount值:', processedCount);
                    
                    if (processedCount !== undefined && processedCount !== null) {
                        if (processedCount === 0) {
                            detailedMessage = `邮件获取完成！耗时${duration}秒，没有找到新邮件`;
                        } else {
                            detailedMessage = `邮件获取完成！耗时${duration}秒，获取到 ${processedCount} 封新邮件`;
                        }
                    }
                    
                    console.log('[DEBUG] 处理后的消息:', detailedMessage);

                    // 重新加载邮件数据，传入true表示这是获取邮件后的加载
                    loadData(true);
                    
                    // 在数据加载完成后显示成功消息，并清除持久化状态
                    setTimeout(() => {
                        showMessage(detailedMessage, 'success');
                        // 清除持久化消息状态
                        currentMessage.isPersistent = false;
                        currentMessage.text = '';
                        currentMessage.type = '';
                    }, 100);
                } else {
                    if (result.message.includes('超时')) {
                        showMessage(`邮件获取超时，操作已被终止。请尝试缩小日期范围或稍后再试`, 'error');
                    } else {
                        showMessage(`邮件获取失败: ${result.message}`, 'error');
                    }
                }
            })
            .catch(error => {
                clearTimeout(timeoutId); // 清除超时定时器
                console.error('获取邮件失败:', error);
                const endTime = Date.now();
                const duration = Math.round((endTime - startTime) / 1000);
                
                if (error.name === 'AbortError' || duration >= 299) {
                    showMessage(`邮件获取超时（${duration}秒），操作可能仍在后台进行。请稍后刷新页面查看结果`, 'error');
                } else {
                    showMessage(`获取邮件失败，请稍后再试`, 'error');
                }
            })
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                // 获取完成后清除持久化消息状态
                currentMessage.isPersistent = false;
            });
        }

        // 从后端API加载数据
        function loadData(isFetching = false) {
            const table = document.getElementById("emailTable").getElementsByTagName('tbody')[0];
            
            // 显示加载状态
            table.innerHTML = '<tr><td colspan="6" class="loading">加载中...</td></tr>';
            
            // 获取搜索关键词
            const keyword = document.getElementById('searchKeyword').value;
            
            // 获取日期范围
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // 显示正在搜索的消息
            if (keyword) {
                showMessage('正在搜索邮件...', 'loading');
            } else if (isFetching) {
                // 如果是获取邮件后的加载，保持显示正在获取邮件的消息
                // 不再重新显示消息，保持现有的持久化消息
            }
            
            // 构建API URL
            let apiUrl = `${API_BASE}/emails`;
            if (keyword) {
                apiUrl = `${API_BASE}/emails/search?keyword=${encodeURIComponent(keyword)}`;
            } else if (startDate && endDate) {
                // 如果没有搜索关键词但有日期范围，则添加日期参数
                apiUrl = `${API_BASE}/emails?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;
            }
            
            fetch(apiUrl)
                .then(response => {
                    // 检查响应状态
                    if (response.status === 503) {
                        // 数据库未初始化，重定向到配置页面
                        window.location.href = '/config';
                        return;
                    }
                    
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                })
                .then(data => {
                    // 检查是否有数据返回
                    if (!data) return;
                    
                    // 存储当前邮件数据
                    currentEmails = data;
                    
                    // 获取排序顺序
                    const sortOrder = document.getElementById('sortOrder').value;
                    
                    // 按时间排序
                    data.sort((a, b) => {
                        const dateA = new Date(a.send_date || '1970-01-01');
                        const dateB = new Date(b.send_date || '1970-01-01');
                        
                        if (sortOrder === 'asc') {
                            return dateA - dateB;
                        } else {
                            return dateB - dateA;
                        }
                    });
                    
                    // 清空现有数据
                    table.innerHTML = '';
                    
                    if (data.length === 0) {
                        table.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无数据</td></tr>';
                        if (keyword) {
                            showMessage(`搜索完成，找到 0 封匹配的邮件`, 'success');
                        }
                        return;
                    }
                    
                    // 添加数据行
                    data.forEach(email => {
                        const row = table.insertRow();
                        row.dataset.id = email.id;
                        
                        // 为已投递的邮件添加特殊样式
                        if (email.is_delivered) {
                            row.style.backgroundColor = '#e6f7e6'; // 浅绿色背景
                        }
                        
                        const cell1 = row.insertCell(0); // 选择框列
                        const cell2 = row.insertCell(1); // 主题列
                        const cell3 = row.insertCell(2); // 发件人列
                        const cell4 = row.insertCell(3); // 时间列
                        const cell5 = row.insertCell(4); // 投递状态列
                        const cell6 = row.insertCell(5); // 操作列
                        
                        cell1.innerHTML = `<input type="checkbox" class="select-checkbox" data-id="${email.id}">`;
                        cell2.textContent = email.subject || '无主题';
                        cell3.textContent = email.sender || '未知发件人';
                        cell4.textContent = formatEmailDate(email.send_date);
                        
                        // 为已投递的邮件添加标记
                        if (email.is_delivered) {
                            cell2.innerHTML = `<span style="color: #28a745; font-weight: bold;">[已投递] </span>${email.subject || '无主题'}`;
                        }
                        
                        // 显示投递状态文本（只读）
                        const statusText = document.createElement('span');
                        statusText.textContent = email.is_delivered ? '已投递' : '未投递';
                        statusText.style.fontWeight = 'bold';
                        if (email.is_delivered) {
                            statusText.style.color = '#28a745'; // 绿色
                        } else {
                            statusText.style.color = '#6c757d'; // 灰色
                        }
                        
                        cell5.appendChild(statusText);
                        
                        // 添加操作按钮
                        cell6.innerHTML = `
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm" onclick="viewEmailBody(${email.id})">查看正文</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteEmail(${email.id})">删除</button>
                            </div>
                        `;
                    });
                    
                    // 添加批量删除按钮
                    const bulkDeleteRow = table.insertRow();
                    const bulkDeleteCell = bulkDeleteRow.insertCell(0);
                    bulkDeleteCell.colSpan = 6;
                    bulkDeleteCell.innerHTML = `
                        <div class="table-bulk-actions">
                            <button class="btn btn-success" onclick="selectAll()">全选</button>
                            <button class="btn btn-danger" onclick="bulkDeleteEmails()">批量删除</button>
                        </div>
                    `;
                    
                    // 显示搜索结果消息
                    if (keyword) {
                        showMessage(`搜索完成，找到 ${data.length} 封匹配的邮件`, 'success');
                    } else if (!isFetching) {
                        // 如果不是搜索操作且不是获取邮件后的加载，显示加载完成的消息
                        showMessage(`加载完成，共找到 ${data.length} 封邮件`, 'success');
                        // 清除持久化消息
                        currentMessage.isPersistent = false;
                        currentMessage.text = '';
                        currentMessage.type = '';
                    }
                })
                .catch(error => {
                    console.error('加载数据失败:', error);
                    table.innerHTML = `<tr><td colspan="5" class="error">加载数据失败: ${error.message}</td></tr>`;
                    showMessage(`加载数据失败: ${error.message}`, 'error');
                    // 出错时清除持久化消息
                    currentMessage.isPersistent = false;
                    currentMessage.text = '';
                    currentMessage.type = '';
                });
        }
        
        // 显示邮件正文
        function showEmailContent(afterRow, content) {
            // 移除已存在的正文行
            const existingContentRow = afterRow.nextElementSibling;
            if (existingContentRow && existingContentRow.classList.contains('email-content-row')) {
                existingContentRow.remove();
            }
            
            const contentRow = document.createElement('tr');
            contentRow.className = 'email-content-row';
            const contentCell = document.createElement('td');
            contentCell.colSpan = 5; // 现在有5列
            contentCell.className = 'email-content';
            
            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.className = 'btn btn-danger btn-sm';
            closeBtn.style.cssText = 'float: right; padding: 0.25rem 0.5rem; margin-bottom: 0.5rem;';
            closeBtn.onclick = function() {
                contentRow.remove();
            };
            
            // 添加展开/收起按钮
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = '展开';
            toggleBtn.className = 'btn btn-primary btn-sm';
            toggleBtn.style.cssText = 'margin-right: 0.5rem;';
            toggleBtn.onclick = function() {
                if (contentDiv.style.maxHeight === '200px' || contentDiv.style.maxHeight === '') {
                    contentDiv.style.maxHeight = 'none';
                    toggleBtn.textContent = '收起';
                } else {
                    contentDiv.style.maxHeight = '200px';
                    toggleBtn.textContent = '展开';
                }
            };
            
            // 创建内容容器
            const contentDiv = document.createElement('div');
            contentDiv.className = 'email-content-text';
            
            // 检查内容是否为HTML格式
            if (content && content.trim().startsWith('<')) {
                // 如果是HTML内容，直接显示（但要确保安全性）
                contentDiv.innerHTML = sanitizeHtml(content);
            } else {
                // 如果是纯文本，转换换行符为<br>标签
                contentDiv.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
            }
            
            // 初始化为收起状态
            contentDiv.style.maxHeight = '200px';
            
            // 将按钮和内容添加到内容单元格
            contentCell.appendChild(closeBtn);
            contentCell.appendChild(toggleBtn);
            contentCell.appendChild(contentDiv);
            
            contentRow.appendChild(contentCell);
            
            // 插入到指定行之后
            afterRow.parentNode.insertBefore(contentRow, afterRow.nextSibling);
        }
        
        // 查看邮件正文
        function viewEmailBody(id) {
            // 显示正在获取邮件正文的提示消息
            showMessage('正在获取邮件正文...', 'loading');
            
            // 从API获取实时邮件正文和准确的邮件数据
            Promise.all([
                fetch(`${API_BASE}/emails/${id}/body/realtime`),
                fetch(`${API_BASE}/emails`) // 获取所有邮件数据以获得准确的时间
            ])
            .then(async responses => {
                const [bodyResponse, emailsResponse] = responses;
                
                // 检查响应状态
                if (bodyResponse.status === 503 || emailsResponse.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (!bodyResponse.ok) {
                    throw new Error(`HTTP error! status: ${bodyResponse.status}`);
                }
                
                if (!emailsResponse.ok) {
                    throw new Error(`HTTP error! status: ${emailsResponse.status}`);
                }
                
                const bodyData = await bodyResponse.json();
                const emailsData = await emailsResponse.json();
                
                // 从完整的邮件数据中找到对应的邮件以获取准确的时间
                let emailData = emailsData.find(email => email.id == id) || null;
                
                // 如果找不到，创建一个基本的邮件数据对象
                if (!emailData) {
                    emailData = { id: id };
                }
                
                return { bodyData, emailData };
            })
            .then(({ bodyData, emailData }) => {
                // 显示获取成功的消息
                showMessage('邮件正文获取成功', 'success');
                // 延迟清除消息，让用户看到成功提示
                setTimeout(() => {
                    document.getElementById('message').className = '';
                    document.getElementById('message').textContent = '';
                }, 1000);
                showEmailModal(bodyData.body || '无邮件正文内容', false, emailData);
            })
            .catch(error => {
                console.error('获取邮件正文失败:', error);
                showMessage(`获取邮件正文失败: ${error.message}`, 'error');
                
                // 即使获取准确数据失败，仍然显示邮件正文（使用表格中的数据）
                const rows = document.querySelectorAll('#emailTable tbody tr');
                let emailData = null;
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.dataset.id === String(id)) {
                        // 从表格行中提取邮件数据
                        const cells = row.cells;
                        emailData = {
                            id: id,
                            subject: cells[1].textContent,
                            sender: cells[2].textContent,
                            send_date: cells[3].textContent
                        };
                        break;
                    }
                }
                
                showEmailModal(`获取邮件正文失败: ${error.message}`, false, emailData);
            });
        }
        
        // 同步到投递汇总系统（已修改为在邮件正文弹窗中直接编辑）
        function syncToDeliverySystem(emailData, emailModal) {
            // 此函数不再需要，因为我们已经在邮件正文弹窗中集成了编辑功能
            // 这里留空以保持向后兼容性
        }
        
        // 从发件人和主题中提取企业名称
        function extractCompanyName(sender, subject) {
            // 尝试从发件人中提取企业名称
            if (sender) {
                // 匹配常见的企业邮箱格式
                const companyPatterns = [
                    /@([^.]*)\.com/,  // @xxx.com
                    /@([^.]*)\.cn/,   // @xxx.cn
                    /([^\s@]+)@/,     // xxx@...
                ];
                
                for (const pattern of companyPatterns) {
                    const match = sender.match(pattern);
                    if (match && match[1]) {
                        // 清理公司名称
                        let companyName = match[1];
                        // 移除常见的前缀
                        companyName = companyName.replace(/^(hr|job|jobs|career|careers|recruit|recruitment|zhaopin|zp)/i, '');
                        if (companyName) {
                            return companyName.charAt(0).toUpperCase() + companyName.slice(1);
                        }
                    }
                }
            }
            
            // 如果从发件人无法提取，尝试从主题中提取
            if (subject) {
                // 匹配主题中的公司名称
                const subjectPatterns = [
                    /面试邀请.*?(.{2,10})/,
                    /笔试通知.*?(.{2,10})/,
                    /([\u4e00-\u9fa5]{2,10})(?:公司)?(?:面试|笔试|招聘)/,
                ];
                
                for (const pattern of subjectPatterns) {
                    const match = subject.match(pattern);
                    if (match && match[1]) {
                        return match[1];
                    }
                }
            }
            
            // 默认返回"未知公司"
            return "未知公司";
        }
        
        // 显示投递表单（已移除，功能集成到邮件正文弹窗中）
        function showDeliveryForm(emailData, emailModal) {
            // 此函数不再需要，因为我们已经在邮件正文弹窗中集成了编辑功能
            // 这里留空以保持向后兼容性
        }
        
        // 保存投递记录
        function saveDeliveryRecord(emailData, emailModal) {
            const companyName = document.getElementById('companyName').value;
            const position = document.getElementById('position').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const status = document.getElementById('status').value;
            
            // 验证必填字段
            if (!companyName || !deliveryDate || !status) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 显示正在添加的消息
            showMessage(`正在添加到投递汇总系统: ${companyName}...`, 'loading');
            
            // 创建投递记录数据
            const deliveryData = {
                company_name: companyName,
                position: position,
                delivery_date: deliveryDate,
                status: status,
                email_id: emailData ? emailData.id : null
            };
            
            // 发送到投递汇总系统API
            fetch(`${API_BASE}/deliveries`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(deliveryData)
            })
            .then(response => {
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => { throw err; });
                }
            })
            .then(result => {
                // 检查是否有结果返回
                if (!result) return;
                
                showMessage(`添加成功: ${companyName} 已添加到投递汇总系统`, 'success');
                
                // 更新邮件的投递状态
                if (emailData && emailData.id) {
                    fetch(`${API_BASE}/emails/${emailData.id}/delivered`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ delivered: true })
                    })
                    .then(response => {
                        if (!response.ok) {
                            console.error('更新邮件投递状态失败');
                        }
                        // 重新加载数据以显示更新后的状态
                        loadData();
                    })
                    .catch(error => {
                        console.error('更新邮件投递状态失败:', error);
                        // 即使更新状态失败，仍然继续关闭弹窗
                        loadData();
                    });
                }
                
                // 关闭邮件正文弹窗
                document.body.removeChild(emailModal);
            })
            .catch(error => {
                console.error('添加到投递汇总系统失败:', error);
                // 检查是否是重复记录错误
                if (error.error && error.error.includes('Duplicate')) {
                    showMessage(`添加失败: 该记录已存在于投递汇总系统中: ${companyName}`, 'error');
                } else {
                    showMessage(`添加失败: ${error.error || '未知错误'}`, 'error');
                }
            });
        }
        
        // 显示邮件弹窗
        function showEmailModal(content, isLoading = false, emailData = null) {
            // 创建弹窗遮罩
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'emailModal';
            modal.style.display = 'block'; // 确保弹窗显示
            
            // 创建弹窗内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.id = 'emailModalContent';
            // 增大弹窗尺寸
            modalContent.style.maxWidth = '800px';
            modalContent.style.maxHeight = '90vh';
            
            // 创建标题栏（用于拖拽）
            const titleBar = document.createElement('div');
            titleBar.className = 'modal-title-bar';
            
            // 添加标题文本
            const titleText = document.createTextNode('邮件正文');
            titleBar.appendChild(titleText);
            
            // 创建关闭按钮
            const closeBtn = document.createElement('span');
            closeBtn.className = 'modal-close';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
            };
            titleBar.appendChild(closeBtn);
            
            // 创建邮件内容容器
            const contentDiv = document.createElement('div');
            contentDiv.className = 'modal-body';
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading">${content}</div>`;
            } else {
                // 检查内容是否为HTML格式
                if (content && content.trim().startsWith('<')) {
                    // 如果是HTML内容，直接显示（但要确保安全性）
                    contentDiv.innerHTML = sanitizeHtml(content);
                } else {
                    // 如果是纯文本，转换换行符为<br>标签
                    contentDiv.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
                }
            }
            
            // 创建企业投递编辑表单容器（默认隐藏）
            const deliveryFormDiv = document.createElement('div');
            deliveryFormDiv.className = 'modal-body';
            deliveryFormDiv.id = 'deliveryFormContainer';
            deliveryFormDiv.style.display = 'none'; // 默认隐藏
            
            // 如果有邮件数据，添加操作按钮
            const footerDiv = document.createElement('div');
            footerDiv.className = 'modal-footer';
            
            if (emailData) {
                // 从邮件中提取建议数据
                const suggestedCompanyName = extractCompanyName(emailData.sender, emailData.subject);
                let suggestedStatus = '投递完成';
                
                // 从邮件数据中获取发送时间，并转换为本地时区的datetime-local格式
                let defaultDeliveryDate = new Date().toISOString().slice(0, 16);
                if (emailData && emailData.send_date) {
                    try {
                        // 将邮件发送时间转换为本地时区的datetime-local格式
                        // 数据库中的send_date可能是字符串格式，需要正确解析
                        let sendDate;
                        if (typeof emailData.send_date === 'string') {
                            // 尝试不同的日期解析方式
                            if (emailData.send_date.includes('T')) {
                                // ISO格式日期
                                sendDate = new Date(emailData.send_date);
                            } else if (emailData.send_date.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                                // MySQL DATETIME格式 (YYYY-MM-DD HH:MM)
                                // 需要添加时区信息，假设数据库存储的是本地时间
                                const [datePart, timePart] = emailData.send_date.split(' ');
                                const isoString = `${datePart}T${timePart}`;
                                sendDate = new Date(isoString);
                            } else {
                                // 其他格式，直接尝试解析
                                sendDate = new Date(emailData.send_date);
                            }
                        } else {
                            // 如果已经是Date对象
                            sendDate = emailData.send_date;
                        }
                        
                        // 检查日期是否有效
                        if (!isNaN(sendDate.getTime())) {
                            // 转换为本地时区的datetime-local格式
                            // datetime-local需要的是本地时间，而不是UTC时间
                            const localDate = new Date(sendDate.getTime() - sendDate.getTimezoneOffset() * 60000);
                            defaultDeliveryDate = localDate.toISOString().slice(0, 16);
                        }
                    } catch (e) {
                        console.error('解析邮件发送时间出错:', e);
                        // 如果解析失败，使用当前时间
                        defaultDeliveryDate = new Date().toISOString().slice(0, 16);
                    }
                }
                
                // 创建企业投递编辑表单
                deliveryFormDiv.innerHTML = `
                    <div class="form-group">
                        <label for="companyName">企业名称 *</label>
                        <input type="text" id="companyName" class="form-control" value="${suggestedCompanyName}" required>
                    </div>
                    <div class="form-group">
                        <label for="position">投递岗位</label>
                        <input type="text" id="position" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="deliveryDate">投递时间 *</label>
                        <input type="datetime-local" id="deliveryDate" class="form-control" value="${defaultDeliveryDate}" required>
                    </div>
                    <div class="form-group">
                        <label for="status">投递状态 *</label>
                        <select id="status" class="form-control" required>
                            <option value="">请选择状态</option>
                            <option value="投递完成">投递完成</option>
                            <option value="简历筛选中">简历筛选中</option>
                            <option value="面试流程中">面试流程中</option>
                            <option value="笔试">笔试</option>
                            <option value="测评">测评</option>
                            <option value="offer发放">offer发放</option>
                            <option value="流程已结束">流程已结束</option>
                            <option value="未知状态">未知状态</option>
                        </select>
                    </div>
                `;
                
                // 添加编辑投递信息按钮
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'btn btn-info';
                editBtn.textContent = '编辑投递信息';
                editBtn.onclick = function() {
                    // 显示编辑表单，隐藏邮件正文
                    contentDiv.style.display = 'none';
                    deliveryFormDiv.style.display = 'block';
                    // 更新标题文本（不覆盖关闭按钮）
                    updateModalTitle(modal, '编辑投递信息');
                    // 确保关闭按钮存在
                    ensureCloseButtonExists(modal);
                    // 显示编辑弹窗的按钮布局
                    showEditModalButtons(modal, emailData);
                };
                
                footerDiv.appendChild(editBtn);
            } else {
                // 如果没有邮件数据，只添加关闭按钮
                const closeBtnFooter = document.createElement('button');
                closeBtnFooter.type = 'button';
                closeBtnFooter.className = 'btn btn-secondary';
                closeBtnFooter.textContent = '关闭';
                closeBtnFooter.onclick = function() {
                    document.body.removeChild(modal);
                };
                
                footerDiv.appendChild(closeBtnFooter);
            }
            
            // 组装弹窗
            titleBar.appendChild(closeBtn);
            modalContent.appendChild(titleBar);
            modalContent.appendChild(contentDiv);
            modalContent.appendChild(deliveryFormDiv);
            modalContent.appendChild(footerDiv);
            modal.appendChild(modalContent);
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 添加拖拽功能（优化版）
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            titleBar.addEventListener('mousedown', dragStart);
            
            function dragStart(e) {
                // 只有点击标题栏时才能拖动
                if (e.target.classList.contains('modal-title-bar') || e.target.closest('.modal-title-bar')) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    isDragging = true;
                    // 添加 grabbing 光标样式
                    titleBar.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    const modalContent = document.getElementById('emailModalContent');
                    modalContent.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
            }
            
            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                // 恢复默认光标样式
                titleBar.style.cursor = 'grab';
            }
            
            // 设置默认光标样式
            titleBar.style.cursor = 'grab';
            
            // 添加鼠标事件监听器（只添加一次）
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            // 点击遮罩关闭弹窗 - 已禁用此功能
            /*
            modal.onclick = function(event) {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            */
            
            // 返回弹窗元素，以便后续操作
            return modal;
        }
        
        // 显示编辑弹窗的按钮布局
        function showEditModalButtons(modal, emailData) {
            const footerDiv = modal.querySelector('.modal-footer');
            // 清空现有的按钮
            footerDiv.innerHTML = '';
            
            // 添加查看邮件正文按钮
            const viewContentBtn = document.createElement('button');
            viewContentBtn.type = 'button';
            viewContentBtn.className = 'btn btn-info';
            viewContentBtn.textContent = '查看邮件正文';
            viewContentBtn.onclick = function() {
                // 显示邮件正文，隐藏编辑表单
                const contentDiv = modal.querySelector('.modal-body');
                const deliveryFormDiv = modal.querySelector('#deliveryFormContainer');
                contentDiv.style.display = 'block';
                deliveryFormDiv.style.display = 'none';
                // 更新标题文本（不覆盖关闭按钮）
                updateModalTitle(modal, '邮件正文');
                // 显示正文弹窗的按钮布局
                showEmailModalButtons(modal, emailData);
            };
            
            // 添加保存到投递汇总按钮
            const saveBtn = document.createElement('button');
            saveBtn.type = 'button';
            saveBtn.className = 'btn btn-success';
            saveBtn.textContent = '保存到投递汇总';
            saveBtn.onclick = function() {
                // 验证表单数据
                const companyName = document.getElementById('companyName').value;
                const position = document.getElementById('position').value;
                const deliveryDate = document.getElementById('deliveryDate').value;
                const status = document.getElementById('status').value;
                
                // 验证必填字段
                let missingFields = [];
                if (!companyName) missingFields.push('企业名称');
                if (!deliveryDate) missingFields.push('投递时间');
                if (!status) missingFields.push('投递状态');
                
                if (missingFields.length > 0) {
                    showMessage('请填写以下必填字段: ' + missingFields.join(', '), 'error');
                    return;
                }
                
                // 保存数据
                saveDeliveryRecord(emailData, modal);
            };
            
            footerDiv.appendChild(viewContentBtn);
            footerDiv.appendChild(saveBtn);
        }
        
        // 显示正文弹窗的按钮布局
        function showEmailModalButtons(modal, emailData) {
            const footerDiv = modal.querySelector('.modal-footer');
            // 清空现有的按钮
            footerDiv.innerHTML = '';
            
            // 添加编辑投递信息按钮
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn btn-info';
            editBtn.textContent = '编辑投递信息';
            editBtn.onclick = function() {
                // 显示编辑表单，隐藏邮件正文
                const contentDiv = modal.querySelector('.modal-body');
                const deliveryFormDiv = modal.querySelector('#deliveryFormContainer');
                contentDiv.style.display = 'none';
                deliveryFormDiv.style.display = 'block';
                // 更新标题文本（不覆盖关闭按钮）
                updateModalTitle(modal, '编辑投递信息');
                // 显示编辑弹窗的按钮布局
                showEditModalButtons(modal, emailData);
            };
            
            footerDiv.appendChild(editBtn);
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.select-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        // 全选
        function selectAll() {
            const checkboxes = document.querySelectorAll('.select-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            // 检查是否已经全选
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            
            // 如果已经全选，则取消全选；否则全选
            const newCheckedState = !allChecked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = newCheckedState;
            });
            selectAllCheckbox.checked = newCheckedState;
        }
        
        // 删除单个邮件
        function deleteEmail(id) {
            if (confirm('确定要删除这封邮件吗？')) {
                // 显示正在删除的消息
                showMessage('正在删除邮件...', 'loading');
                
                // 发送删除请求
                fetch(`${API_BASE}/emails/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    // 检查响应状态
                    if (response.status === 503) {
                        // 数据库未初始化，重定向到配置页面
                        window.location.href = '/config';
                        return;
                    }
                    
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                })
                .then(result => {
                    // 检查是否有结果返回
                    if (!result) return;
                    
                    showMessage('邮件删除成功！', 'success');
                    // 重新加载数据
                    loadData();
                    // 在数据加载完成后恢复显示持久化消息
                    setTimeout(restorePersistentMessage, 100);
                })
                .catch(error => {
                    console.error('删除邮件失败:', error);
                    showMessage(`删除邮件失败: ${error.message}`, 'error');
                });
            }
        }
        
        // 批量删除邮件
        function bulkDeleteEmails() {
            const selectedCheckboxes = document.querySelectorAll('.select-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showMessage('请先选择要删除的邮件', 'error');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedCheckboxes.length} 封邮件吗？`)) {
                // 显示正在删除的消息
                showMessage(`正在删除 ${selectedCheckboxes.length} 封邮件...`, 'loading');
                
                let deletePromises = [];
                
                selectedCheckboxes.forEach(checkbox => {
                    const id = checkbox.dataset.id;
                    
                    // 创建删除请求的Promise
                    const deletePromise = fetch(`${API_BASE}/emails/${id}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        // 检查响应状态
                        if (response.status === 503) {
                            // 数据库未初始化，重定向到配置页面
                            window.location.href = '/config';
                            return;
                        }
                        
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    });
                    
                    deletePromises.push(deletePromise);
                });
                
                // 等待所有删除请求完成
                Promise.all(deletePromises)
                    .then(results => {
                        // 检查是否有结果返回
                        if (results.length === 0) return;
                        
                        showMessage(`成功删除 ${results.length} 封邮件！`, 'success');
                        // 重新加载数据
                        loadData();
                        // 在数据加载完成后恢复显示持久化消息
                        setTimeout(restorePersistentMessage, 100);
                    })
                    .catch(error => {
                        console.error('批量删除邮件失败:', error);
                        showMessage(`批量删除邮件失败: ${error.message}`, 'error');
                    });
            }
        }
        
        
        
        // 保存投递记录
        function saveDeliveryRecord(emailData, emailModal) {
            const companyName = document.getElementById('companyName').value;
            const position = document.getElementById('position').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const status = document.getElementById('status').value;
            
            // 验证必填字段
            if (!companyName || !deliveryDate || !status) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 显示正在添加的消息
            showMessage(`正在添加到投递汇总系统: ${companyName}...`, 'loading');
            
            // 创建投递记录数据
            const deliveryData = {
                company_name: companyName,
                position: position,
                delivery_date: deliveryDate,
                status: status,
                email_id: emailData ? emailData.id : null
            };
            
            // 发送到投递汇总系统API
            fetch(`${API_BASE}/deliveries`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(deliveryData)
            })
            .then(response => {
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => { throw err; });
                }
            })
            .then(result => {
                // 检查是否有结果返回
                if (!result) return;
                
                showMessage(`添加成功: ${companyName} 已添加到投递汇总系统`, 'success');
                
                // 更新邮件的投递状态
                if (emailData && emailData.id) {
                    fetch(`${API_BASE}/emails/${emailData.id}/delivered`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ delivered: true })
                    })
                    .then(response => {
                        if (!response.ok) {
                            console.error('更新邮件投递状态失败');
                        }
                        // 重新加载数据以显示更新后的状态
                        loadData();
                    })
                    .catch(error => {
                        console.error('更新邮件投递状态失败:', error);
                        // 即使更新状态失败，仍然继续关闭弹窗
                        loadData();
                    });
                }
                
                // 关闭邮件正文弹窗
                document.body.removeChild(emailModal);
            })
            .catch(error => {
                console.error('添加到投递汇总系统失败:', error);
                // 检查是否是重复记录错误
                if (error.error && error.error.includes('Duplicate')) {
                    showMessage(`添加失败: 该记录已存在于投递汇总系统中: ${companyName}`, 'error');
                } else {
                    showMessage(`添加失败: ${error.error || '未知错误'}`, 'error');
                }
            });
        }
        
        // 更新弹窗标题（不覆盖关闭按钮）
        function updateModalTitle(modal, title) {
            const titleBar = modal.querySelector('.modal-title-bar');
            
            // 查找现有的关闭按钮
            const existingCloseBtn = titleBar.querySelector('.modal-close');
            
            // 清空标题栏内容
            titleBar.innerHTML = '';
            
            // 添加标题文本
            const titleText = document.createTextNode(title);
            titleBar.appendChild(titleText);
            
            // 如果之前有关闭按钮，重新添加它
            if (existingCloseBtn) {
                titleBar.appendChild(existingCloseBtn);
            } else {
                // 如果没有关闭按钮，创建一个新的
                const closeBtn = document.createElement('span');
                closeBtn.className = 'modal-close';
                closeBtn.innerHTML = '×';
                closeBtn.onclick = function() {
                    document.body.removeChild(modal);
                };
                titleBar.appendChild(closeBtn);
            }
        }
        
        // 确保关闭按钮存在
        function ensureCloseButtonExists(modal) {
            const titleBar = modal.querySelector('.modal-title-bar');
            const closeBtn = titleBar.querySelector('.modal-close');
            
            // 如果关闭按钮不存在，则创建一个
            if (!closeBtn) {
                const newCloseBtn = document.createElement('span');
                newCloseBtn.className = 'modal-close';
                newCloseBtn.innerHTML = '×';
                newCloseBtn.onclick = function() {
                    document.body.removeChild(modal);
                };
                // 将关闭按钮添加到标题栏的末尾
                titleBar.appendChild(newCloseBtn);
            }
        }
        
        // 邮件排序功能
        function sortEmails() {
            // 重新加载并排序数据
            loadData();
        }
        
        // 格式化时间显示
        function formatEmailDate(dateString) {
            if (!dateString) return '未知时间';
            
            try {
                // 解析原始日期字符串
                let date;
                if (dateString.includes('T')) {
                    // ISO格式日期
                    date = new Date(dateString);
                } else if (dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                    // MySQL DATETIME格式 (YYYY-MM-DD HH:MM)
                    date = new Date(dateString.replace(' ', 'T'));
                } else {
                    // 其他格式，直接尝试解析
                    date = new Date(dateString);
                }
                
                // 检查日期是否有效
                if (isNaN(date.getTime())) {
                    return dateString; // 如果无法解析，返回原始字符串
                }
                
                // 格式化为更易读的格式: YYYY-MM-DD HH:mm
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (error) {
                console.error('日期格式化错误:', error);
                return dateString; // 如果出错，返回原始字符串
            }
        }
        
        // HTML转义函数，防止XSS攻击同时正确显示内容
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&")
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, '"')
                .replace(/'/g, "'");
        }
        
        // 简单的HTML净化函数，只允许安全的HTML标签
        function sanitizeHtml(unsafe) {
            if (typeof unsafe !== 'string') return escapeHtml(unsafe);
            
            // 移除潜在危险的标签和属性
            return unsafe
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
                .replace(/on\w+="[^"]*"/gi, '')
                .replace(/on\w+='[^']*'/gi, '')
                .replace(/on\w+=[^>\s]*/gi, '')
                .replace(/javascript:/gi, '')
                .replace(/vbscript:/gi, '');
        }
    </script>
</body>
</html>