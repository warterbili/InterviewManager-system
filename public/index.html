<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面试管理系统</title>
    <link rel="stylesheet" href="./common.css">
</head>
<body>
    <div class="main-header">
        <div class="container">
            <h1 class="main-title">面试管理系统</h1>
            <p class="main-subtitle">一站式管理您的求职面试流程，轻松跟踪邮件状态和投递进度</p>
            <div class="main-actions">
                <button class="btn btn-primary btn-main" onclick="location.href='/config'">
                    修改系统配置
                </button>
                <button class="btn btn-danger btn-main" onclick="exitSystem()">
                    退出系统
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="system-grid">
            <div class="system-card" onclick="location.href='/schedule'">
                <div class="card-icon">📅</div>
                <h2 class="card-title">面试日程安排</h2>
                <p class="card-description">管理您的面试日程，包括公司、岗位、时间等信息。可以标记准备状态和完成情况。</p>
            </div>
            
            <div class="system-card" onclick="location.href='/emails'">
                <div class="card-icon">📧</div>
                <h2 class="card-title">企业邮件跟踪</h2>
                <p class="card-description">跟踪企业发送的各类邮件，包括面试邀请、笔试通知、评测结果等。</p>
            </div>
            
            <div class="system-card" onclick="location.href='/deliveries'">
                <div class="card-icon">📋</div>
                <h2 class="card-title">企业投递汇总</h2>
                <p class="card-description">记录和管理您的企业投递情况，包括投递时间、状态等信息。</p>
            </div>
            
            <div class="system-card" onclick="location.href='/analytics'">
                <div class="card-icon">📊</div>
                <h2 class="card-title">数据可视化分析</h2>
                <p class="card-description">以图表形式展示面试和投递数据，帮助您更好地了解求职进度和趋势。</p>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2025 面试管理系统 - 助您轻松管理求职过程</p>
        </div>
    </div>

    <script>
        // 检查配置是否完整，如果不完整则重定向到配置页面
        document.addEventListener('DOMContentLoaded', function() {
            // 从服务器获取配置
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    // 检查数据库配置是否完整（host, user, password是必需的）
                    const hasDbConfig = config.db.host && config.db.user && config.db.password;
                    // 检查邮箱配置是否完整
                    const hasEmailConfig = config.email.address && config.email.password && config.email.imap_server;
                    
                    // 如果数据库或邮箱配置不完整，则重定向到配置页面
                    if (!hasDbConfig || !hasEmailConfig) {
                        const currentUrl = encodeURIComponent(window.location.pathname);
                        window.location.href = `/config?returnUrl=${currentUrl}`;
                    }
                })
                .catch(error => {
                    console.error('获取配置失败:', error);
                    // 如果获取配置失败，也重定向到配置页面，并传递当前页面作为返回URL
                    const currentUrl = encodeURIComponent(window.location.pathname);
                    window.location.href = `/config?returnUrl=${currentUrl}`;
                });
        });
        
        // 退出系统函数
        function exitSystem() {
            if (confirm('确定要退出系统吗？这将关闭服务器并退出程序。')) {
                // 发送退出请求到服务器
                fetch('/api/exit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // 尝试关闭浏览器窗口
                    window.close();
                    
                    // 如果window.close()不起作用，则立即跳转到一个空白页面
                    setTimeout(() => {
                        document.body.innerHTML = '<div style="text-align:center;margin-top:50px;"><h2>系统已关闭</h2><p>您可以关闭此窗口。</p></div>';
                        // 防止用户继续操作
                        document.body.style.pointerEvents = 'none';
                    }, 1000);
                })
                .catch(error => {
                    console.error('退出系统时出错:', error);
                    // 即使出错也尝试关闭窗口
                    window.close();
                    // 如果window.close()不起作用，则立即跳转到一个空白页面
                    setTimeout(() => {
                        document.body.innerHTML = '<div style="text-align:center;margin-top:50px;"><h2>系统已关闭</h2><p>您可以关闭此窗口。</p></div>';
                        // 防止用户继续操作
                        document.body.style.pointerEvents = 'none';
                    }, 1000);
                });
            }
        }
    </script>
</body>
</html>