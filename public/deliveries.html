<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业投递汇总</title>
    <link rel="stylesheet" href="./common.css">
</head>
<body>
    <a href="#main-content" class="skip-link">跳转到主要内容</a>
    <div class="page-header">
        <div class="container">
            <h1>企业投递汇总</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="/" class="back-btn">
                ← 返回主页
            </a>
        </div>
        
        <main id="main-content">
            <div class="card">
                <div class="card-header">
                    <h2 id="form-title">企业投递汇总</h2>
                </div>
                
                <form id="deliveryForm" aria-labelledby="form-title">
                    <input type="hidden" id="recordId">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="companyName">企业名称 *</label>
                                <input type="text" id="companyName" class="form-control" required aria-describedby="companyNameHelp">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="position">投递岗位</label>
                                <input type="text" id="position" class="form-control" aria-describedby="positionHelp">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="deliveryDate">投递时间 *</label>
                                <input type="datetime-local" id="deliveryDate" class="form-control" required aria-describedby="deliveryDateHelp">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="status">投递状态 *</label>
                                <select id="status" class="form-control" required aria-describedby="statusHelp">
                                    <option value="">请选择状态</option>
                                    <option value="投递完成">投递完成</option>
                                    <option value="简历筛选中">简历筛选中</option>
                                    <option value="面试流程中">面试流程中</option>
                                    <option value="笔试">笔试</option>
                                    <option value="测评">测评</option>
                                    <option value="offer发放">offer发放</option>
                                    <option value="流程已结束">流程已结束</option>
                                    <option value="未知状态">未知状态</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="searchInput">搜索:</label>
                            <div class="search-container">
                                <input type="text" id="searchInput" class="form-control" placeholder="搜索企业名称、岗位、状态等...">
                                <button id="searchBtn" class="btn btn-primary">搜索</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="sortOrder">排序方式:</label>
                            <select id="sortOrder" class="form-control">
                                <option value="desc">时间降序（最新优先）</option>
                                <option value="asc">时间升序（最早优先）</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>操作:</label>
                            <div class="action-buttons">
                                <button type="button" class="btn btn-success btn-sm" id="saveBtn">
                                    保存记录
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" id="resetBtn">
                                    重置
                                </button>
                                <button type="button" class="btn btn-info btn-sm" id="exportBtn">
                                    导出CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>投递记录列表</h2>
                </div>
                
                <div id="message" class="message" role="status" aria-live="polite"></div>
                
                <div class="table-container">
                    <table id="deliveryTable" class="delivery-table" aria-label="投递记录列表">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">企业名称</th>
                                <th scope="col">投递岗位</th>
                                <th scope="col">投递时间</th>
                                <th scope="col">投递状态</th>
                                <th scope="col">备注</th>
                                <th scope="col">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将从后端API加载 -->
                        </tbody>
                    </table>
                </div>
            </div>

    <!-- 备注弹窗 -->
    <div id="notesModal" class="modal">
        <div class="modal-content" id="notesModalContent">
            <div class="modal-title-bar">
                <h2>添加/编辑备注</h2>
                <span class="modal-close" onclick="closeNotesModal()">×</span>
            </div>
            <div class="modal-body">
                <textarea id="notesTextarea" placeholder="请输入备注内容..."></textarea>
                <div class="char-count">
                    <span id="charCounter">0</span> 字符
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeNotesModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveNotes()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 检查配置，如果没有则重定向到配置页面
        // 从服务器获取配置
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                // 检查是否至少有一些基本的数据库配置
                const hasBasicDbConfig = config.db.host || config.db.user || config.db.password;
                
                // 如果没有任何基本数据库配置，重定向到配置页面，并传递当前页面作为返回URL
                if (!hasBasicDbConfig) {
                    const currentUrl = encodeURIComponent(window.location.pathname);
                    window.location.href = `/config?returnUrl=${currentUrl}`;
                }
            })
            .catch(error => {
                console.error('获取配置失败:', error);
                // 如果获取配置失败，也重定向到配置页面，并传递当前页面作为返回URL
                const currentUrl = encodeURIComponent(window.location.pathname);
                window.location.href = `/config?returnUrl=${currentUrl}`;
            });

        // API基础URL
        const API_BASE = '/api';
        
        // 格式化日期显示
        function formatDeliveryDate(dateString) {
            return dateString ? new Date(dateString).toLocaleString('zh-CN') : '';
        }
        
        // 显示消息函数
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type + ' show';
            
            // loading消息不自动清除，其他消息5秒后自动清除
            if (type !== 'loading') {
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = '';
                }, 5000);
            }
        }

        // 页面加载时从后端API获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // 添加事件监听器
            document.getElementById('saveBtn').addEventListener('click', saveRecord);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('searchBtn').addEventListener('click', function() {
                loadData();
            });
            
            // 为排序选择器添加事件监听器
            document.getElementById('sortOrder').addEventListener('change', function() {
                const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
                const rows = Array.from(table.rows);
                
                // 按时间排序
                sortTableRows(rows);
            });
            
            // 为搜索输入框添加事件监听器
            document.getElementById('searchInput').addEventListener('input', function() {
                filterTable();
            });
            
            // 为搜索框添加回车键事件监听器
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadData();
                }
            });
            
            // 为备注文本区域添加字符计数监听器
            document.getElementById('notesTextarea').addEventListener('input', updateCharCount);
        });

        // 按时间排序表格行
        function sortTableRows(rows) {
            const sortOrder = document.getElementById('sortOrder').value;
            
            rows.sort((a, b) => {
                // 获取每行的时间文本内容
                const dateTextA = a.cells[2].textContent;
                const dateTextB = b.cells[2].textContent;
                
                // 将日期字符串转换为Date对象进行比较
                const dateA = dateTextA ? new Date(dateTextA) : new Date(0);
                const dateB = dateTextB ? new Date(dateTextB) : new Date(0);
                
                if (sortOrder === 'asc') {
                    return dateA - dateB;
                } else {
                    return dateB - dateA;
                }
            });
            
            // 重新排列行
            const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
            rows.forEach(row => table.appendChild(row));
        }

        // 存储原始数据
        let originalData = [];
        
        // 从后端API加载数据
        function loadData() {
            const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
            
            // 获取搜索关键词
            const keyword = document.getElementById('searchInput').value;
            
            // 显示加载状态
            table.innerHTML = '<tr><td colspan="7" class="loading">加载中...</td></tr>';
            
            // 显示正在搜索的消息
            if (keyword) {
                showMessage('正在搜索投递记录...', 'loading');
            } else {
                showMessage('正在加载投递记录...', 'loading');
            }
            
            // 构建API URL
            let apiUrl = `${API_BASE}/deliveries`;
            if (keyword) {
                apiUrl = `${API_BASE}/deliveries/search?keyword=${encodeURIComponent(keyword)}`;
            }
            
            fetch(apiUrl)
                .then(response => {
                    // 检查响应状态
                    if (response.status === 503) {
                        // 数据库未初始化，重定向到配置页面
                        window.location.href = '/config';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    // 检查是否有数据返回
                    if (!data) return;
                    
                    // 保存原始数据
                    originalData = data;
                    
                    // 清空现有数据
                    table.innerHTML = '';
                    
                    if (data.length === 0) {
                        table.innerHTML = '<tr><td colspan="7" style="text-align: center;">暂无投递记录</td></tr>';
                        if (keyword) {
                            showMessage(`搜索完成，找到 0 条匹配的记录`, 'success');
                        } else {
                            showMessage('加载完成，暂无投递记录', 'success');
                        }
                        return;
                    }
                    
                    data.forEach(item => {
                        addRowToTable(item);
                    });
                    
                    // 获取排序顺序
                    const sortOrder = document.getElementById('sortOrder').value;
                    
                    // 获取所有数据行
                    const rows = Array.from(table.rows);
                    
                    // 按时间排序
                    sortTableRows(rows);
                    
                    if (keyword) {
                        showMessage(`搜索完成，找到 ${data.length} 条匹配的记录`, 'success');
                    } else {
                        showMessage(`加载完成，共找到 ${data.length} 条投递记录`, 'success');
                    }
                })
                .catch(error => {
                    console.error('加载数据失败:', error);
                    table.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">加载数据失败: ' + error.message + '</td></tr>';
                    showMessage('加载数据失败: ' + error.message, 'error');
                });
        }

        // 添加行到表格（使用DOM方法而不是innerHTML以提高安全性）
        function addRowToTable(item) {
            const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            newRow.dataset.id = item.id;
            
            // 格式化日期显示
            const formattedDate = formatDeliveryDate(item.delivery_date);
            
            // 创建单元格
            const idCell = newRow.insertCell(0);
            const companyCell = newRow.insertCell(1);
            const positionCell = newRow.insertCell(2);
            const dateCell = newRow.insertCell(3);
            const statusCell = newRow.insertCell(4);
            const notesCell = newRow.insertCell(5);
            const actionCell = newRow.insertCell(6);
            
            // 填充单元格内容
            idCell.textContent = item.id;
            companyCell.textContent = item.company_name;
            positionCell.textContent = item.position || '';
            dateCell.textContent = formattedDate;
            statusCell.textContent = item.status;
            notesCell.innerHTML = '<div class="notes-cell"><button type="button" class="btn btn-secondary btn-sm" onclick="openNotesModal(this)">备注</button></div>';
            
            // 存储备注内容在行元素上
            newRow.notes = item.notes || '';
            
            // 创建操作按钮
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn btn-warning btn-sm';
            editBtn.textContent = '编辑';
            editBtn.onclick = () => editRecord(item.id, item.company_name, item.position, item.delivery_date, item.status);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = () => deleteRecord(item.id);
            
            // 添加按钮到操作单元格
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.appendChild(editBtn);
            actionDiv.appendChild(deleteBtn);
            actionCell.appendChild(actionDiv);
            actionCell.className = 'action-cell';
        }
        
        // 根据搜索关键词筛选表格
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
            
            // 清空表格
            table.innerHTML = '';
            
            // 如果没有搜索词，显示所有数据
            if (!searchTerm) {
                originalData.forEach(item => {
                    addRowToTable(item);
                });
                
                // 获取排序顺序
                const sortOrder = document.getElementById('sortOrder').value;
                
                // 获取所有数据行
                const rows = Array.from(table.rows);
                
                // 按时间排序
                sortTableRows(rows);
                
                showMessage(`共找到 ${originalData.length} 条投递记录`, 'success');
                return;
            }
            
            // 筛选数据
            const filteredData = originalData.filter(item => {
                return (
                    (item.company_name && item.company_name.toLowerCase().includes(searchTerm)) ||
                    (item.position && item.position.toLowerCase().includes(searchTerm)) ||
                    (item.status && item.status.toLowerCase().includes(searchTerm)) ||
                    (item.delivery_date && formatDeliveryDate(item.delivery_date).toLowerCase().includes(searchTerm))
                );
            });
            
            // 显示筛选后的数据
            if (filteredData.length === 0) {
                table.innerHTML = '<tr><td colspan="7" style="text-align: center;">未找到匹配的记录</td></tr>';
                showMessage('未找到匹配的记录', 'success');
                return;
            }
            
            filteredData.forEach(item => {
                addRowToTable(item);
            });
            
            // 获取排序顺序
            const sortOrder = document.getElementById('sortOrder').value;
            
            // 获取所有数据行
            const rows = Array.from(table.rows);
            
            // 按时间排序
            sortTableRows(rows);
            
            showMessage(`找到 ${filteredData.length} 条匹配的记录`, 'success');
        }
        
        // 编辑记录
        function editRecord(id, companyName, position, deliveryDate, status) {
            // 设置表单标题
            document.getElementById('form-title').textContent = '编辑投递记录';
            
            // 填充表单数据
            document.getElementById('recordId').value = id;
            document.getElementById('companyName').value = companyName;
            document.getElementById('position').value = position || '';
            document.getElementById('deliveryDate').value = deliveryDate ? deliveryDate.slice(0, 16) : '';
            document.getElementById('status').value = status;
            
            // 显示消息
            showMessage(`正在编辑记录: ${companyName}`, 'success');
            
            // 滚动到表单顶部
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 重置表单
        function resetForm() {
            // 重置表单标题
            document.getElementById('form-title').textContent = '企业投递汇总';
            
            // 清空表单数据
            document.getElementById('recordId').value = '';
            document.getElementById('deliveryForm').reset();
            
            // 显示消息
            showMessage('表单已重置', 'success');
        }
        
        // 保存记录（添加或更新）
        function saveRecord() {
            const id = document.getElementById('recordId').value;
            const companyName = document.getElementById('companyName').value;
            const position = document.getElementById('position').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const status = document.getElementById('status').value;
            
            // 验证必填字段
            if (!companyName || !deliveryDate || !status) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 构造不包含notes字段的记录数据
            const recordData = {
                company_name: companyName,
                position: position,
                delivery_date: deliveryDate,
                status: status
            };
            
            let url = `${API_BASE}/deliveries`;
            let method = 'POST';
            
            // 如果有ID，则为更新操作
            if (id) {
                url += `/${id}`;
                method = 'PUT';
                showMessage(`正在更新记录: ${companyName}...`, 'loading');
            } else {
                showMessage(`正在添加记录: ${companyName}...`, 'loading');
            }
            
            // 发送到后端API
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(recordData)
            })
            .then(response => {
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(result => {
                // 检查是否有结果返回
                if (!result) return;
                
                showMessage(id ? `记录更新成功: ${companyName}` : `记录添加成功: ${companyName}`, 'success');
                resetForm();
                loadData(); // 重新加载数据
            })
            .catch(error => {
                console.error('保存记录失败:', error);
                const errorMsg = error.error || '保存记录失败';
                showMessage(`${id ? '更新' : '添加'}记录失败: ${errorMsg}`, 'error');
            });
        }
        
        // 删除记录
        function deleteRecord(id) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }
            
            // 显示正在删除的消息
            showMessage('正在删除记录...', 'loading');
            
            // 发送到后端API
            fetch(`${API_BASE}/deliveries/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(result => {
                // 检查是否有结果返回
                if (!result) return;
                
                showMessage('记录删除成功！', 'success');
                loadData(); // 重新加载数据
            })
            .catch(error => {
                console.error('删除记录失败:', error);
                const errorMsg = error.error || '删除记录失败';
                showMessage(`删除记录失败: ${errorMsg}`, 'error');
            });
        }
        
        // 备注弹窗相关变量
        let currentRow = null;
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        // 打开备注弹窗
        function openNotesModal(button) {
            currentRow = button.closest('tr');
            const notes = currentRow.notes || '';
            const companyName = currentRow.cells[1].textContent || '';
            const position = currentRow.cells[2].textContent || '';
            
            // 设置弹窗标题
            const modalTitle = document.querySelector('#notesModal .modal-title-bar h2');
            modalTitle.textContent = `备注 - ${companyName}${position ? ' (' + position + ')' : ''}`;
            
            const textarea = document.getElementById('notesTextarea');
            textarea.value = notes;
            document.getElementById('notesModal').style.display = 'block';
            
            // 重置弹窗位置
            xOffset = 0;
            yOffset = 0;
            const modalContent = document.getElementById('notesModalContent');
            modalContent.style.transform = 'translate(-50%, -50%)';
            
            // 更新字符计数
            updateCharCount();
            
            // 聚焦到文本区域
            setTimeout(() => {
                textarea.focus();
            }, 100);
        }
        
        // 更新字符计数
        function updateCharCount() {
            const textarea = document.getElementById('notesTextarea');
            const charCount = textarea.value.length;
            document.getElementById('charCounter').textContent = charCount;
        }
        
        // 关闭备注弹窗
        function closeNotesModal() {
            document.getElementById('notesModal').style.display = 'none';
            currentRow = null;
        }
        
        // 保存备注
        function saveNotes() {
            if (currentRow) {
                const notes = document.getElementById('notesTextarea').value;
                const id = currentRow.dataset.id;
                const companyName = currentRow.cells[1].textContent || '';
                
                // 更新前端显示
                currentRow.notes = notes;
                showMessage('备注保存成功', 'success');
                
                // 如果有ID，则直接更新数据库中的备注
                if (id) {
                    fetch(`${API_BASE}/deliveries/${id}/notes`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ notes: notes })
                    })
                    .then(response => {
                        if (response.status === 503) {
                            // 数据库未初始化，重定向到配置页面
                            window.location.href = '/config';
                            return;
                        }
                        
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (!result) return;
                        showMessage('备注已保存到数据库', 'success');
                    })
                    .catch(error => {
                        console.error('保存备注失败:', error);
                        const errorMsg = error.error || '保存备注失败';
                        showMessage(`保存备注失败: ${errorMsg}`, 'error');
                    });
                }
            }
            closeNotesModal();
        }
        
        // 弹窗拖动开始
        function dragStart(e) {
            // 只有点击标题栏时才能拖动
            if (e.target.classList.contains('modal-title-bar') || e.target.closest('.modal-title-bar')) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                isDragging = true;
                e.preventDefault();
            }
        }
        
        // 弹窗拖动中
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                xOffset = currentX;
                yOffset = currentY;
                
                const modalContent = document.getElementById('notesModalContent');
                modalContent.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
            }
        }
        
        // 弹窗拖动结束
        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
        
        // 为弹窗标题栏添加拖动事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const modalTitleBar = document.querySelector('#notesModal .modal-title-bar');
            if (modalTitleBar) {
                modalTitleBar.addEventListener('mousedown', dragStart);
            }
        });
        
        // 添加鼠标事件监听器（只添加一次）
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        // 点击弹窗外部关闭弹窗 - 已禁用此功能
        /*
        window.onclick = function(event) {
            const modal = document.getElementById('notesModal');
            const modalContent = document.getElementById('notesModalContent');
            // 检查点击的是否是弹窗遮罩层（而不是弹窗内容）
            if (event.target === modal) {
                closeNotesModal();
            }
        };
        */
        
        // 导出数据为CSV文件
        function exportToCSV() {
            // 获取表格数据
            const data = originalData;
            
            if (data.length === 0) {
                showMessage('没有数据可导出', 'error');
                return;
            }
            
            // 定义CSV列标题
            const headers = ['ID', '企业名称', '投递岗位', '投递时间', '投递状态', '备注'];
            
            // 创建CSV内容
            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // 添加BOM以支持中文
            
            // 添加数据行
            data.forEach(item => {
                const row = [
                    item.id,
                    item.company_name,
                    item.position || '',
                    formatDeliveryDate(item.delivery_date),
                    item.status,
                    item.notes || ''
                ];
                
                // 转义包含逗号或双引号的字段
                const escapedRow = row.map(field => {
                    if (field === null || field === undefined) return '';
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                
                csvContent += escapedRow.join(',') + '\n';
            });
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', '企业投递汇总_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSV文件导出成功', 'success');
        }
    </script>
</body>
</html>