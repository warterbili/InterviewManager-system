<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业投递汇总</title>
    <link rel="stylesheet" href="./common.css">
<style>
        /* 面试弹窗样式 */
        #interviewModal .modal-body {
            padding: var(--spacing-md);
        }
        
        #interviewModal .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        #interviewModal .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--gray-800);
            font-size: 0.9rem;
        }
        
        #interviewModal .form-control {
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            transition: var(--transition-normal);
            box-sizing: border-box;
            background-color: var(--white-color);
            min-height: var(--form-control-height);
            color: var(--gray-900);
        }
        
        #interviewModal .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }
        
        #interviewModal .modal-footer {
            padding: var(--spacing-sm);
        }
        
        /* 提高弹窗中文本的对比度 */
        #interviewModal {
            color: var(--gray-900);
        }
        
        #interviewModal h2 {
            color: var(--white-color);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">跳转到主要内容</a>
    <div class="page-header">
        <div class="container">
            <h1>企业投递汇总</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="/" class="back-btn">
                ← 返回主页
            </a>
        </div>
        
        <main id="main-content">
            <div class="card">
                <div class="card-header">
                    <h2 id="form-title">企业投递汇总</h2>
                </div>
                
                <form id="deliveryForm" aria-labelledby="form-title">
                    <input type="hidden" id="recordId">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="companyName">企业名称 *</label>
                                <input type="text" id="companyName" class="form-control" required aria-describedby="companyNameHelp">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="position">投递岗位</label>
                                <input type="text" id="position" class="form-control" aria-describedby="positionHelp">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="deliveryDate">投递时间 *</label>
                                <input type="datetime-local" id="deliveryDate" class="form-control" required aria-describedby="deliveryDateHelp">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="status">投递状态 *</label>
                                <select id="status" class="form-control" required aria-describedby="statusHelp">
                                    <option value="">请选择状态</option>
                                    <option value="投递完成">投递完成</option>
                                    <option value="简历筛选中">简历筛选中</option>
                                    <option value="面试流程中">面试流程中</option>
                                    <option value="笔试">笔试</option>
                                    <option value="测评">测评</option>
                                    <option value="offer发放">offer发放</option>
                                    <option value="流程已结束">流程已结束</option>
                                    <option value="未知状态">未知状态</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="searchInput">搜索:</label>
                            <div class="search-container">
                                <input type="text" id="searchInput" class="form-control" placeholder="搜索企业名称、岗位、状态等...">
                                <button type="button" id="searchBtn" class="btn btn-primary">搜索</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="sortOrder">排序方式:</label>
                            <select id="sortOrder" class="form-control">
                                <option value="desc">时间降序（最新优先）</option>
                                <option value="asc">时间升序（最早优先）</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>操作:</label>
                            <div class="action-buttons">
                                <button type="button" class="btn btn-success btn-sm" id="saveBtn">
                                    保存记录
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" id="resetBtn">
                                    重置
                                </button>
                                <button type="button" class="btn btn-info btn-sm" id="exportBtn">
                                    导出CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>投递记录列表</h2>
                    <div class="email-list-actions">
                        <button class="btn btn-success" onclick="selectAll()">全选</button>
                        <button class="btn btn-danger" onclick="bulkDeleteRecords()">批量删除</button>
                    </div>
                </div>
                
                <div id="message" class="message" role="status" aria-live="polite"></div>
                
                <div class="table-container">
                    <table id="deliveryTable" class="delivery-table" aria-label="投递记录列表">
                        <thead>
                            <tr>
                                <th scope="col"><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()"></th>
                                <th scope="col">企业名称</th>
                                <th scope="col">投递岗位</th>
                                <th scope="col">投递时间</th>
                                <th scope="col">投递状态</th>
                                <th scope="col">邮件正文</th>
                                <th scope="col">备注</th>
                                <th scope="col">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将从后端API加载 -->
                        </tbody>
                    </table>
                </div>
            </div>

    <!-- 备注弹窗 -->
    <div id="notesModal" class="modal">
        <div class="modal-content" id="notesModalContent">
            <div class="modal-title-bar">
                <h2>添加/编辑备注</h2>
                <span class="modal-close" onclick="closeNotesModal()">×</span>
            </div>
            <div class="modal-body">
                <textarea id="notesTextarea" placeholder="请输入备注内容..."></textarea>
                <div class="char-count">
                    <span id="charCounter">0</span> 字符
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeNotesModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveNotes()">保存</button>
            </div>
        </div>
    </div>

    <!-- 面试日程编辑弹窗 -->
    <div id="interviewModal" class="modal">
        <div class="modal-content" id="interviewModalContent">
            <div class="modal-title-bar">
                <h2>添加到面试日程</h2>
                <span class="modal-close" onclick="closeInterviewModal()">×</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="interviewId">
                <div class="form-group">
                    <label for="interviewCompanyName">企业名称 *</label>
                    <input type="text" id="interviewCompanyName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="interviewPosition">面试岗位</label>
                    <input type="text" id="interviewPosition" class="form-control">
                </div>
                <div class="form-group">
                    <label for="interviewDate">面试时间 *</label>
                    <input type="datetime-local" id="interviewDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="interviewStatus">面试状态 *</label>
                    <select id="interviewStatus" class="form-control" required>
                        <option value="">请选择状态</option>
                        <option value="一面">一面</option>
                        <option value="二面">二面</option>
                        <option value="终面">终面</option>
                        <option value="HR面">HR面</option>
                        <option value="等待面试开始">等待面试开始</option>
                        <option value="面试已结束">面试已结束</option>
                        <option value="已取消">已取消</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="interviewResult">面试结果</label>
                    <select id="interviewResult" class="form-control">
                        <option value="">请选择结果</option>
                        <option value="等待面试开始">等待面试开始</option>
                        <option value="通过">通过</option>
                        <option value="未通过">未通过</option>
                        <option value="待定">待定</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeInterviewModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveInterview()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 检查配置，如果没有则重定向到配置页面
        // 从服务器获取配置
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                // 检查是否至少有一些基本的数据库配置
                const hasBasicDbConfig = config.db.host || config.db.user || config.db.password;
                
                // 如果没有任何基本数据库配置，重定向到配置页面，并传递当前页面作为返回URL
                if (!hasBasicDbConfig) {
                    const currentUrl = encodeURIComponent(window.location.pathname);
                    window.location.href = `/config?returnUrl=${currentUrl}`;
                }
            })
            .catch(error => {
                console.error('获取配置失败:', error);
                // 如果获取配置失败，也重定向到配置页面，并传递当前页面作为返回URL
                const currentUrl = encodeURIComponent(window.location.pathname);
                window.location.href = `/config?returnUrl=${currentUrl}`;
            });

        // API基础URL
        const API_BASE = '/api';
        
        // 格式化日期显示
        function formatDeliveryDate(dateString) {
            return dateString ? new Date(dateString).toLocaleString('zh-CN') : '';
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.select-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        // 全选
        function selectAll() {
            const checkboxes = document.querySelectorAll('.select-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            // 检查是否已经全选
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            
            // 如果已经全选，则取消全选；否则全选
            const newCheckedState = !allChecked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = newCheckedState;
            });
            selectAllCheckbox.checked = newCheckedState;
        }
        
        // 查看邮件正文
        function viewEmailBody(id) {
            // 显示正在获取邮件正文的提示消息
            showMessage('正在获取邮件正文...', 'loading');
            
            // 从API获取实时邮件正文
            fetch(`${API_BASE}/emails/${id}/body/realtime`)
                .then(response => {
                    // 检查响应状态
                    if (response.status === 503) {
                        // 数据库未初始化，重定向到配置页面
                        window.location.href = '/config';
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 显示获取成功的消息
                    showMessage('邮件正文获取成功', 'success');
                    // 延迟清除消息，让用户看到成功提示
                    setTimeout(() => {
                        document.getElementById('message').className = '';
                        document.getElementById('message').textContent = '';
                    }, 1000);
                    showEmailModal(data.body || '无邮件正文内容');
                })
                .catch(error => {
                    console.error('获取邮件正文失败:', error);
                    showMessage(`获取邮件正文失败: ${error.message}`, 'error');
                    showEmailModal(`获取邮件正文失败: ${error.message}`);
                });
        }
        
        // 显示邮件弹窗（简化版，无编辑功能）
        function showEmailModal(content, isLoading = false) {
            // 创建弹窗遮罩
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'emailModal';
            modal.style.display = 'block'; // 确保弹窗显示
            
            // 创建弹窗内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.id = 'emailModalContent';
            // 增大弹窗尺寸
            modalContent.style.maxWidth = '800px';
            modalContent.style.maxHeight = '90vh';
            
            // 创建标题栏（用于拖拽）
            const titleBar = document.createElement('div');
            titleBar.className = 'modal-title-bar';
            
            // 添加标题文本
            const titleText = document.createTextNode('邮件正文');
            titleBar.appendChild(titleText);
            
            // 创建关闭按钮
            const closeBtn = document.createElement('span');
            closeBtn.className = 'modal-close';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
            };
            titleBar.appendChild(closeBtn);
            
            // 创建邮件内容容器
            const contentDiv = document.createElement('div');
            contentDiv.className = 'modal-body';
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading">${content}</div>`;
            } else {
                // 检查内容是否为HTML格式
                if (content && content.trim().startsWith('<')) {
                    // 如果是HTML内容，直接显示（但要确保安全性）
                    contentDiv.innerHTML = sanitizeHtml(content);
                } else {
                    // 如果是纯文本，转换换行符为<br>标签
                    contentDiv.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
                }
            }
            
            // 创建弹窗底部按钮区域
            const footerDiv = document.createElement('div');
            footerDiv.className = 'modal-footer';
            
            // 添加关闭按钮
            const closeBtnFooter = document.createElement('button');
            closeBtnFooter.type = 'button';
            closeBtnFooter.className = 'btn btn-secondary';
            closeBtnFooter.textContent = '关闭';
            closeBtnFooter.onclick = function() {
                document.body.removeChild(modal);
            };
            
            footerDiv.appendChild(closeBtnFooter);
            
            // 组装弹窗
            modalContent.appendChild(titleBar);
            modalContent.appendChild(contentDiv);
            modalContent.appendChild(footerDiv);
            modal.appendChild(modalContent);
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 添加拖拽功能（优化版）
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            titleBar.addEventListener('mousedown', dragStart);
            
            function dragStart(e) {
                // 只有点击标题栏时才能拖动
                if (e.target.classList.contains('modal-title-bar') || e.target.closest('.modal-title-bar')) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    isDragging = true;
                    // 添加 grabbing 光标样式
                    titleBar.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    const modalContent = document.getElementById('emailModalContent');
                    modalContent.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
            }
            
            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                // 恢复默认光标样式
                titleBar.style.cursor = 'grab';
            }
            
            // 设置默认光标样式
            titleBar.style.cursor = 'grab';
            
            // 添加鼠标事件监听器（只添加一次）
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            // 返回弹窗元素，以便后续操作
            return modal;
        }
        
        // HTML转义函数，防止XSS攻击同时正确显示内容
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&")
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, '"')
                .replace(/'/g, "'");
        }
        
        // 简单的HTML净化函数，只允许安全的HTML标签
        function sanitizeHtml(unsafe) {
            if (typeof unsafe !== 'string') return escapeHtml(unsafe);
            
            // 移除潜在危险的标签和属性
            return unsafe
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
                .replace(/on\w+="[^"]*"/gi, '')
                .replace(/on\w+='[^']*'/gi, '')
                .replace(/on\w+=[^>\s]*/gi, '')
                .replace(/javascript:/gi, '')
                .replace(/vbscript:/gi, '');
        }
        
        // 显示消息函数
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type + ' show';
            
            // loading消息不自动清除，其他消息5秒后自动清除
            if (type !== 'loading') {
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = '';
                }, 5000);
            }
        }

        // 页面加载时从后端API获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // 添加事件监听器
            document.getElementById('saveBtn').addEventListener('click', saveRecord);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('searchBtn').addEventListener('click', function() {
                loadData();
            });
            
            // 为排序选择器添加事件监听器
            document.getElementById('sortOrder').addEventListener('change', function() {
                const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
                const rows = Array.from(table.rows);
                
                // 按时间排序
                sortTableRows(rows);
            });
            
            // 为搜索框添加回车键事件监听器
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadData();
                }
            });
            
            // 为备注文本区域添加字符计数监听器
            document.getElementById('notesTextarea').addEventListener('input', updateCharCount);
        });

        // 按时间排序表格行
        function sortTableRows(rows) {
            const sortOrder = document.getElementById('sortOrder').value;
            
            rows.sort((a, b) => {
                // 获取每行的时间文本内容
                const dateTextA = a.cells[2].textContent;
                const dateTextB = b.cells[2].textContent;
                
                // 将日期字符串转换为Date对象进行比较
                const dateA = dateTextA ? new Date(dateTextA) : new Date(0);
                const dateB = dateTextB ? new Date(dateTextB) : new Date(0);
                
                if (sortOrder === 'asc') {
                    return dateA - dateB;
                } else {
                    return dateB - dateA;
                }
            });
            
            // 重新排列行
            const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
            rows.forEach(row => table.appendChild(row));
        }

        // 存储原始数据
        let originalData = [];
        
        // 从后端API加载数据
        function loadData() {
            const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
            
            // 获取搜索关键词
            const keyword = document.getElementById('searchInput').value.trim();
            
            // 显示加载状态
            table.innerHTML = '<tr><td colspan="7" class="loading">加载中...</td></tr>';
            
            // 显示正在搜索的消息
            if (keyword) {
                showMessage('正在搜索投递记录...', 'loading');
            } else {
                showMessage('正在加载投递记录...', 'loading');
            }
            
            // 构建API URL
            let apiUrl = `${API_BASE}/deliveries`;
            if (keyword) {
                apiUrl = `${API_BASE}/deliveries/search?keyword=${encodeURIComponent(keyword)}`;
            }
            
            fetch(apiUrl)
                .then(response => {
                    // 检查响应状态
                    if (response.status === 503) {
                        // 数据库未初始化，重定向到配置页面
                        window.location.href = '/config';
                        return;
                    }
                    // 检查响应是否成功
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 检查是否有数据返回
                    if (!data) {
                        data = []; // 确保data是一个数组
                    }
                    
                    // 保存原始数据
                    originalData = data;
                    
                    // 清空现有数据
                    table.innerHTML = '';
                    
                    if (data.length === 0) {
                        table.innerHTML = '<tr><td colspan="7" style="text-align: center;">暂无投递记录</td></tr>';
                        if (keyword) {
                            showMessage(`搜索完成，找到 0 条匹配的记录`, 'success');
                        } else {
                            showMessage('加载完成，暂无投递记录', 'success');
                        }
                        return;
                    }
                    
                    // 清空表格
                    table.innerHTML = '';
                    
                    data.forEach(item => {
                        addRowToTable(item);
                    });
                    
                    // 获取排序顺序
                    const sortOrder = document.getElementById('sortOrder').value;
                    
                    // 获取所有数据行
                    const rows = Array.from(table.rows);
                    
                    // 按时间排序
                    sortTableRows(rows);
                    
                    if (keyword) {
                        showMessage(`搜索完成，找到 ${data.length} 条匹配的记录`, 'success');
                    } else {
                        showMessage(`加载完成，共找到 ${data.length} 条投递记录`, 'success');
                    }
                })
                .catch(error => {
                    console.error('加载数据失败:', error);
                    table.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">加载数据失败: ' + (error.message || '未知错误') + '</td></tr>';
                    showMessage('加载数据失败: ' + (error.message || '未知错误'), 'error');
                });
        }

        // 添加行到表格（使用DOM方法而不是innerHTML以提高安全性）
        function addRowToTable(item) {
            const table = document.getElementById("deliveryTable").getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            newRow.dataset.id = item.id;
            
            // 为整行添加点击事件，打开面试日程弹窗
            newRow.addEventListener('click', function(e) {
                // 如果点击的是按钮或复选框，则不触发弹窗
                if (e.target.tagName === 'BUTTON' || e.target.type === 'checkbox') {
                    return;
                }
                openInterviewModal(item);
            });
            
            // 格式化日期显示
            const formattedDate = formatDeliveryDate(item.delivery_date);
            
            // 创建单元格
            const selectCell = newRow.insertCell(0);
            const companyCell = newRow.insertCell(1);
            const positionCell = newRow.insertCell(2);
            const dateCell = newRow.insertCell(3);
            const statusCell = newRow.insertCell(4);
            const emailBodyCell = newRow.insertCell(5);
            const notesCell = newRow.insertCell(6);
            const actionCell = newRow.insertCell(7);
            
            // 添加复选框
            selectCell.innerHTML = `<input type="checkbox" class="select-checkbox" data-id="${item.id}">`;
            
            // 填充单元格内容
            companyCell.textContent = item.company_name;
            positionCell.textContent = item.position || '';
            dateCell.textContent = formattedDate;
            statusCell.textContent = item.status;
            
            // 添加邮件正文按钮（如果有邮件ID）
            if (item.email_id) {
                emailBodyCell.innerHTML = '<div class="email-body-cell"><button type="button" class="btn btn-info btn-sm" onclick="viewEmailBody(' + item.email_id + ')">查看正文</button></div>';
            } else {
                emailBodyCell.textContent = '';
            }
            
            notesCell.innerHTML = '<div class="notes-cell"><button type="button" class="btn btn-secondary btn-sm" onclick="openNotesModal(this)">备注</button></div>';
            
            // 存储备注内容在行元素上
            newRow.notes = item.notes || '';
            
            // 创建操作按钮
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn btn-warning btn-sm';
            editBtn.textContent = '编辑';
            editBtn.onclick = () => editRecord(item.id, item.company_name, item.position, item.delivery_date, item.status);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = () => deleteRecord(item.id);
            
            // 添加按钮到操作单元格
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.appendChild(editBtn);
            actionDiv.appendChild(deleteBtn);
            actionCell.appendChild(actionDiv);
            actionCell.className = 'action-cell';
        }
        
        // 根据搜索关键词筛选表格
        function filterTable() {
            // 此函数已被弃用，搜索现在通过 loadData() 函数处理
            loadData();
        }
        
        // 编辑记录
        function editRecord(id, companyName, position, deliveryDate, status) {
            // 设置表单标题
            document.getElementById('form-title').textContent = '编辑投递记录';
            
            // 填充表单数据
            document.getElementById('recordId').value = id;
            document.getElementById('companyName').value = companyName;
            document.getElementById('position').value = position || '';
            document.getElementById('deliveryDate').value = deliveryDate ? deliveryDate.slice(0, 16) : '';
            document.getElementById('status').value = status;
            
            // 显示消息
            showMessage(`正在编辑记录: ${companyName}`, 'success');
            
            // 滚动到表单顶部
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 重置表单
        function resetForm() {
            // 重置表单标题
            document.getElementById('form-title').textContent = '企业投递汇总';
            
            // 清空表单数据
            document.getElementById('recordId').value = '';
            document.getElementById('deliveryForm').reset();
            
            // 显示消息
            showMessage('表单已重置', 'success');
        }
        
        // 保存记录（添加或更新）
        function saveRecord() {
            const id = document.getElementById('recordId').value;
            const companyName = document.getElementById('companyName').value;
            const position = document.getElementById('position').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const status = document.getElementById('status').value;
            
            // 验证必填字段
            if (!companyName || !deliveryDate || !status) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 构造不包含notes字段的记录数据
            const recordData = {
                company_name: companyName,
                position: position,
                delivery_date: deliveryDate,
                status: status
            };
            
            let url = `${API_BASE}/deliveries`;
            let method = 'POST';
            
            // 如果有ID，则为更新操作
            if (id) {
                url += `/${id}`;
                method = 'PUT';
                showMessage(`正在更新记录: ${companyName}...`, 'loading');
            } else {
                showMessage(`正在添加记录: ${companyName}...`, 'loading');
            }
            
            // 发送到后端API
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(recordData)
            })
            .then(response => {
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(result => {
                // 检查是否有结果返回
                if (!result) return;
                
                showMessage(id ? `记录更新成功: ${companyName}` : `记录添加成功: ${companyName}`, 'success');
                resetForm();
                loadData(); // 重新加载数据
            })
            .catch(error => {
                console.error('保存记录失败:', error);
                const errorMsg = error.error || '保存记录失败';
                showMessage(`${id ? '更新' : '添加'}记录失败: ${errorMsg}`, 'error');
            });
        }
        
        // 删除记录
        function deleteRecord(id) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }
            
            // 显示正在删除的消息
            showMessage('正在删除记录...', 'loading');
            
            // 发送到后端API
            fetch(`${API_BASE}/deliveries/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(result => {
                // 检查是否有结果返回
                if (!result) return;
                
                showMessage('记录删除成功！', 'success');
                loadData(); // 重新加载数据
            })
            .catch(error => {
                console.error('删除记录失败:', error);
                const errorMsg = error.error || '删除记录失败';
                showMessage(`删除记录失败: ${errorMsg}`, 'error');
            });
        }
        
        // 批量删除记录
        function bulkDeleteRecords() {
            const selectedCheckboxes = document.querySelectorAll('.select-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showMessage('请先选择要删除的记录', 'error');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedCheckboxes.length} 条记录吗？`)) {
                return;
            }
            
            // 显示正在删除的消息
            showMessage(`正在删除 ${selectedCheckboxes.length} 条记录...`, 'loading');
            
            let deletePromises = [];
            
            selectedCheckboxes.forEach(checkbox => {
                const id = checkbox.dataset.id;
                
                // 创建删除请求的Promise
                const deletePromise = fetch(`${API_BASE}/deliveries/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    // 检查响应状态
                    if (response.status === 503) {
                        // 数据库未初始化，重定向到配置页面
                        window.location.href = '/config';
                        return;
                    }
                    
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                });
                
                deletePromises.push(deletePromise);
            });
            
            // 等待所有删除请求完成
            Promise.all(deletePromises)
                .then(results => {
                    // 检查是否有结果返回
                    if (results.length === 0) return;
                    
                    showMessage(`成功删除 ${results.length} 条记录！`, 'success');
                    // 重新加载数据
                    loadData();
                    // 取消全选
                    document.getElementById('selectAllCheckbox').checked = false;
                })
                .catch(error => {
                    console.error('批量删除记录失败:', error);
                    const errorMsg = error.error || error.message || '批量删除记录失败';
                    showMessage(`批量删除记录失败: ${errorMsg}`, 'error');
                });
        }
        
        // 备注弹窗相关变量
        let currentRow = null;
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        // 打开备注弹窗
        function openNotesModal(button) {
            currentRow = button.closest('tr');
            const notes = currentRow.notes || '';
            const companyName = currentRow.cells[1].textContent || '';
            const position = currentRow.cells[2].textContent || '';
            
            // 设置弹窗标题
            const modalTitle = document.querySelector('#notesModal .modal-title-bar h2');
            modalTitle.textContent = `备注 - ${companyName}${position ? ' (' + position + ')' : ''}`;
            
            const textarea = document.getElementById('notesTextarea');
            textarea.value = notes;
            document.getElementById('notesModal').style.display = 'block';
            
            // 重置弹窗位置
            xOffset = 0;
            yOffset = 0;
            const modalContent = document.getElementById('notesModalContent');
            modalContent.style.transform = 'translate(-50%, -50%)';
            
            // 更新字符计数
            updateCharCount();
            
            // 聚焦到文本区域
            setTimeout(() => {
                textarea.focus();
            }, 100);
        }
        
        // 更新字符计数
        function updateCharCount() {
            const textarea = document.getElementById('notesTextarea');
            const charCount = textarea.value.length;
            document.getElementById('charCounter').textContent = charCount;
        }
        
        // 关闭备注弹窗
        function closeNotesModal() {
            document.getElementById('notesModal').style.display = 'none';
            currentRow = null;
        }
        
        // 打开面试日程弹窗
        function openInterviewModal(deliveryData) {
            console.log('Opening interview modal with delivery data:', deliveryData);
            
            // 填充默认数据
            document.getElementById('interviewId').value = '';
            document.getElementById('interviewCompanyName').value = deliveryData.company_name || '';
            document.getElementById('interviewPosition').value = deliveryData.position || '';
            
            // 设置默认面试时间为投递时间
            let interviewDate = new Date();
            if (deliveryData.delivery_date) {
                interviewDate = new Date(deliveryData.delivery_date);
            }
            
            // 确保日期格式正确 (YYYY-MM-DDTHH:mm)
            const formattedDate = interviewDate.toISOString().slice(0, 16);
            document.getElementById('interviewDate').value = formattedDate;
            
            console.log('Setting interview date to:', formattedDate);
            
            document.getElementById('interviewStatus').value = '一面';
            document.getElementById('interviewResult').value = '等待面试开始';
            
            // 显示弹窗
            document.getElementById('interviewModal').style.display = 'block';
            
            // 重置弹窗位置
            const modalContent = document.getElementById('interviewModalContent');
            modalContent.style.transform = 'translate(-50%, -50%)';
            
            // 验证数据是否正确填充
            console.log('Interview company name:', document.getElementById('interviewCompanyName').value);
            console.log('Interview date:', document.getElementById('interviewDate').value);
        }
        
        // 关闭面试日程弹窗
        function closeInterviewModal() {
            document.getElementById('interviewModal').style.display = 'none';
        }
        
        // 保存面试日程
        function saveInterview() {
            const id = document.getElementById('interviewId').value;
            const companyName = document.getElementById('interviewCompanyName').value;
            const position = document.getElementById('interviewPosition').value;
            const interviewDate = document.getElementById('interviewDate').value;
            const status = document.getElementById('interviewStatus').value;
            const result = document.getElementById('interviewResult').value;
            
            console.log('Saving interview with data:', {
                id: id,
                companyName: companyName,
                position: position,
                interviewDate: interviewDate,
                status: status,
                result: result
            });
            
            // 验证必填字段
            if (!companyName || !interviewDate || !status) {
                showMessage('请填写所有必填字段', 'error');
                console.log('Validation failed:', {
                    companyName: !!companyName,
                    interviewDate: !!interviewDate,
                    status: !!status
                });
                return;
            }
            
            // 构造面试日程数据
            const interviewData = {
                company_name: companyName,
                position: position,
                interview_date: interviewDate,
                status: status,
                result: result
            };
            
            console.log('Sending interview data:', interviewData);
            
            let url = `${API_BASE}/interviews`;
            let method = 'POST';
            let action = '添加';
            
            // 如果有ID，则为更新操作
            if (id) {
                url += `/${id}`;
                method = 'PUT';
                action = '更新';
                showMessage(`正在更新面试日程: ${companyName}...`, 'loading');
            } else {
                showMessage(`正在添加面试日程: ${companyName}...`, 'loading');
            }
            
            // 发送到后端API
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(interviewData)
            })
            .then(response => {
                console.log('API response status:', response.status);
                // 检查响应状态
                if (response.status === 503) {
                    // 数据库未初始化，重定向到配置页面
                    window.location.href = '/config';
                    return;
                }
                
                if (!response.ok) {
                    return response.json().then(err => { 
                        console.error('API error response:', err);
                        throw err; 
                    });
                }
                return response.json();
            })
            .then(result => {
                // 检查是否有结果返回
                if (!result) return;
                
                showMessage(`${action}面试日程成功: ${companyName}`, 'success');
                closeInterviewModal();
                // 重新加载数据以反映更改
                loadData();
            })
            .catch(error => {
                console.error('保存面试日程失败:', error);
                const errorMsg = error.error || error.message || '保存面试日程失败';
                showMessage(`${action}面试日程失败: ${errorMsg}`, 'error');
            });
        }
        
        // 保存备注
        function saveNotes() {
            if (currentRow) {
                const notes = document.getElementById('notesTextarea').value;
                const id = currentRow.dataset.id;
                const companyName = currentRow.cells[1].textContent || '';
                
                // 更新前端显示
                currentRow.notes = notes;
                showMessage('备注保存成功', 'success');
                
                // 如果有ID，则直接更新数据库中的备注
                if (id) {
                    fetch(`${API_BASE}/deliveries/${id}/notes`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ notes: notes })
                    })
                    .then(response => {
                        if (response.status === 503) {
                            // 数据库未初始化，重定向到配置页面
                            window.location.href = '/config';
                            return;
                        }
                        
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (!result) return;
                        showMessage('备注已保存到数据库', 'success');
                    })
                    .catch(error => {
                        console.error('保存备注失败:', error);
                        const errorMsg = error.error || '保存备注失败';
                        showMessage(`保存备注失败: ${errorMsg}`, 'error');
                    });
                }
            }
            closeNotesModal();
        }
        
        // 弹窗拖动开始
        function dragStart(e) {
            // 只有点击标题栏时才能拖动
            if (e.target.classList.contains('modal-title-bar') || e.target.closest('.modal-title-bar')) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                isDragging = true;
                // 设置光标样式
                e.target.style.cursor = 'grabbing';
                e.preventDefault();
            }
        }
        
        // 弹窗拖动中
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                xOffset = currentX;
                yOffset = currentY;
                
                // 更新所有打开的弹窗位置
                const notesModalContent = document.getElementById('notesModalContent');
                const interviewModalContent = document.getElementById('interviewModalContent');
                const emailModalContent = document.getElementById('emailModalContent');
                
                if (notesModalContent && notesModalContent.style.display !== 'none') {
                    notesModalContent.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
                
                if (interviewModalContent && interviewModalContent.style.display !== 'none') {
                    interviewModalContent.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
                
                if (emailModalContent && emailModalContent.style.display !== 'none') {
                    emailModalContent.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
            }
        }
        
        // 弹窗拖动结束
        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
            // 恢复光标样式
            document.body.style.cursor = 'default';
        }
        
        // 为弹窗标题栏添加拖动事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const modalTitleBar = document.querySelector('#notesModal .modal-title-bar');
            if (modalTitleBar) {
                modalTitleBar.addEventListener('mousedown', dragStart);
            }
            
            // 为面试弹窗标题栏添加拖动事件监听器
            const interviewModalTitleBar = document.querySelector('#interviewModal .modal-title-bar');
            if (interviewModalTitleBar) {
                interviewModalTitleBar.addEventListener('mousedown', function(e) {
                    // 只有点击标题栏时才能拖动
                    if (e.target.classList.contains('modal-title-bar') || e.target.closest('.modal-title-bar')) {
                        initialX = e.clientX - xOffset;
                        initialY = e.clientY - yOffset;
                        isDragging = true;
                        // 添加 grabbing 光标样式
                        interviewModalTitleBar.style.cursor = 'grabbing';
                        e.preventDefault();
                    }
                });
            }
        });
        
        // 添加鼠标事件监听器（只添加一次）
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        // 点击弹窗外部关闭弹窗 - 已禁用此功能
        /*
        window.onclick = function(event) {
            const notesModal = document.getElementById('notesModal');
            const interviewModal = document.getElementById('interviewModal');
            const emailModal = document.getElementById('emailModal');
            
            // 检查点击的是否是弹窗遮罩层（而不是弹窗内容）
            if (event.target === notesModal) {
                closeNotesModal();
            } else if (event.target === interviewModal) {
                closeInterviewModal();
            } else if (event.target === emailModal) {
                // 关闭邮件弹窗的代码需要从已有的邮件弹窗中复制
                if (document.getElementById('emailModal')) {
                    document.body.removeChild(document.getElementById('emailModal'));
                }
            }
        };
        */
        
        // 导出数据为CSV文件
        function exportToCSV() {
            // 获取表格数据
            const data = originalData;
            
            if (data.length === 0) {
                showMessage('没有数据可导出', 'error');
                return;
            }
            
            // 定义CSV列标题
            const headers = ['ID', '企业名称', '投递岗位', '投递时间', '投递状态', '备注'];
            
            // 创建CSV内容
            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // 添加BOM以支持中文
            
            // 添加数据行
            data.forEach(item => {
                const row = [
                    item.id,
                    item.company_name,
                    item.position || '',
                    formatDeliveryDate(item.delivery_date),
                    item.status,
                    item.notes || ''
                ];
                
                // 转义包含逗号或双引号的字段
                const escapedRow = row.map(field => {
                    if (field === null || field === undefined) return '';
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                
                csvContent += escapedRow.join(',') + '\n';
            });
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', '企业投递汇总_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSV文件导出成功', 'success');
        }
    </script>
</body>
</html>